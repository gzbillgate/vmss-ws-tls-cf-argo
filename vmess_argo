#!/bin/bash

#=============================================================================
#  Xray + Cloudflare Argo Tunnel 一键部署管理脚本
#  版本：v2.6 (set-e 修复版)
#  修复：grep 退出码导致脚本提前退出
#=============================================================================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# 全局变量
SCRIPT_VERSION="2.6"
XRAY_VERSION=""
CF_VERSION=""
UUID=""
WS_PATH=""
XRAY_PORT=""
CF_DOMAIN=""
TUNNEL_ID=""
TUNNEL_NAME=""
OS_PRETTY=""
ARCH=""
ARCH_NAME=""

# 日志函数
log_info() { echo -e "${GREEN}[✓ INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[⚠ WARN]${NC} $1"; }
log_error() { echo -e "${RED}[✗ ERROR]${NC} $1"; }
log_step() { echo -e "${BLUE}[➤ STEP]${NC} $1"; }
log_success() { echo -e "${GREEN}[✓ SUCCESS]${NC} $1"; }
log_progress() { echo -e "${CYAN}[...]${NC} $1"; }

show_banner() {
    clear
    echo -e "${PURPLE}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║     Xray + Cloudflare Argo Tunnel 一键部署管理系统        ║"
    echo "║                        版本：${SCRIPT_VERSION}                    ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

check_root() {
    if [ "$EUID" -ne 0 ]; then
        log_error "请使用 root 用户运行此脚本"
        exit 1
    fi
}

detect_system() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_PRETTY=$PRETTY_NAME
    else
        OS_PRETTY="Unknown"
    fi
    
    ARCH_RAW=$(uname -m)
    case $ARCH_RAW in
        x86_64)
            ARCH="64"
            ARCH_NAME="amd64"
            ;;
        aarch64|arm64)
            ARCH="arm64"
            ARCH_NAME="arm64"
            ;;
        armv7l|armv7)
            ARCH="arm32-v7a"
            ARCH_NAME="arm"
            ;;
        *)
            ARCH="64"
            ARCH_NAME="amd64"
            ;;
    esac
    
    log_info "系统：$OS_PRETTY | 架构：$ARCH_RAW ($ARCH)"
}

detect_package_manager() {
    if command -v apt &> /dev/null; then
        PM="apt"
        PM_UPDATE="apt update -y"
        PM_INSTALL="apt install -y"
    elif command -v yum &> /dev/null; then
        PM="yum"
        PM_UPDATE="yum update -y"
        PM_INSTALL="yum install -y"
    elif command -v dnf &> /dev/null; then
        PM="dnf"
        PM_UPDATE="dnf update -y"
        PM_INSTALL="dnf install -y"
    else
        PM="apt"
        PM_UPDATE="apt update -y"
        PM_INSTALL="apt install -y"
    fi
}

check_installation_status() {
    XRAY_INSTALLED=false
    CF_INSTALLED=false
    XRAY_RUNNING=false
    CF_RUNNING=false
    
    if [ -f /usr/local/bin/xray ]; then
        XRAY_INSTALLED=true
        XRAY_VERSION=$(/usr/local/bin/xray version 2>/dev/null | head -1 || echo "未知")
    fi
    
    if [ -f /usr/local/bin/cloudflared ]; then
        CF_INSTALLED=true
        CF_VERSION=$(/usr/local/bin/cloudflared version 2>/dev/null || echo "未知")
    fi
    
    if systemctl is-active --quiet xray 2>/dev/null; then
        XRAY_RUNNING=true
    fi
    
    if systemctl is-active --quiet cloudflared 2>/dev/null; then
        CF_RUNNING=true
    fi
    
    # 【修复】grep 命令添加 || true 防止退出
    if [ -f /etc/xray/config.json ]; then
        UUID=$(jq -r '.inbounds[0].settings.clients[0].id' /etc/xray/config.json 2>/dev/null || echo "")
        XRAY_PORT=$(jq -r '.inbounds[0].port' /etc/xray/config.json 2>/dev/null || echo "")
        WS_PATH=$(jq -r '.inbounds[0].streamSettings.wsSettings.path' /etc/xray/config.json 2>/dev/null | tr -d '/' || echo "")
    fi
    
    if [ -f /etc/cloudflared/config.yml ]; then
        CF_DOMAIN=$(grep 'hostname:' /etc/cloudflared/config.yml 2>/dev/null | awk '{print $2}' || echo "")
        TUNNEL_ID=$(cat /etc/cloudflared/tunnel-id 2>/dev/null || echo "")
    fi
}

install_dependencies() {
    log_step "安装系统依赖..."
    $PM_UPDATE >/dev/null 2>&1 || true
    $PM_INSTALL curl wget jq tar gzip unzip socat uuid-runtime >/dev/null 2>&1 || true
    log_success "依赖安装完成"
}

install_xray() {
    log_step "安装 Xray-core..."
    cd /tmp
    
    log_progress "获取最新版本..."
    LATEST_VERSION=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest 2>/dev/null | grep '"tag_name"' | cut -d'"' -f4 || echo "v26.2.6")
    
    if [ -z "$LATEST_VERSION" ] || ! echo "$LATEST_VERSION" | grep -qE '^v[0-9]+'; then
        LATEST_VERSION="v26.2.6"
    fi
    
    log_info "使用版本：$LATEST_VERSION"
    
    local FILENAME="Xray-linux-${ARCH}.zip"
    local DOWNLOAD_URL="https://github.com/XTLS/Xray-core/releases/download/${LATEST_VERSION}/${FILENAME}"
    
    log_info "下载文件：$FILENAME"
    
    local MIRRORS=(
        "$DOWNLOAD_URL"
        "https://mirror.ghproxy.com/https://github.com/XTLS/Xray-core/releases/download/${LATEST_VERSION}/${FILENAME}"
        "https://ghproxy.com/https://github.com/XTLS/Xray-core/releases/download/${LATEST_VERSION}/${FILENAME}"
    )
    
    local DOWNLOAD_SUCCESS=false
    
    for URL in "${MIRRORS[@]}"; do
        log_progress "尝试：$URL"
        rm -f xray.zip
        
        if curl -sL --connect-timeout 30 --max-time 90 -o xray.zip "$URL" 2>/dev/null; then
            if [ -s xray.zip ]; then
                if unzip -t xray.zip >/dev/null 2>&1; then
                    log_success "下载成功"
                    DOWNLOAD_SUCCESS=true
                    break
                else
                    log_warn "文件损坏，尝试其他源..."
                fi
            fi
        fi
    done
    
    if [ "$DOWNLOAD_SUCCESS" = false ]; then
        log_error "所有下载源都失败"
        log_error "请手动下载：curl -L -o /tmp/xray.zip $DOWNLOAD_URL"
        exit 1
    fi
    
    log_progress "解压安装..."
    unzip -q -o xray.zip
    mkdir -p /etc/xray /var/log/xray
    chmod +x xray xray-core
    mv -f xray /usr/local/bin/
    mv -f xray-core /usr/local/bin/
    mv -f geoip.dat /etc/xray/ 2>/dev/null || true
    mv -f geosite.dat /etc/xray/ 2>/dev/null || true
    rm -f xray.zip
    
    XRAY_VERSION=$(/usr/local/bin/xray version | head -1)
    log_success "Xray-core 安装完成：$XRAY_VERSION"
}

install_cloudflared() {
    log_step "安装 cloudflared..."
    
    case $ARCH in
        64) CF_ARCH="amd64" ;;
        arm64) CF_ARCH="arm64" ;;
        arm32-v7a) CF_ARCH="arm" ;;
        *) CF_ARCH="amd64" ;;
    esac
    
    local CF_URLS=(
        "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${CF_ARCH}"
        "https://mirror.ghproxy.com/https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${CF_ARCH}"
    )
    
    for URL in "${CF_URLS[@]}"; do
        log_progress "尝试：$URL"
        if curl -sL --connect-timeout 30 --max-time 60 -o /tmp/cloudflared "$URL" 2>/dev/null; then
            if [ -s /tmp/cloudflared ]; then
                chmod +x /tmp/cloudflared
                mv -f /tmp/cloudflared /usr/local/bin/cloudflared
                CF_VERSION=$(/usr/local/bin/cloudflared version)
                log_success "cloudflared 安装完成：$CF_VERSION"
                return 0
            fi
        fi
    done
    
    log_error "cloudflared 下载失败"
    exit 1
}

generate_uuid() {
    if command -v uuidgen &> /dev/null; then
        uuidgen | tr '[:upper:]' '[:lower:]'
    elif command -v uuid &> /dev/null; then
        uuid | tr '[:upper:]' '[:lower:]'
    else
        cat /proc/sys/kernel/random/uuid
    fi
}

create_xray_config() {
    log_step "创建 Xray 配置文件..."
    cat > /etc/xray/config.json << EOF
{
    "log": {
        "loglevel": "warning",
        "access": "/var/log/xray/access.log",
        "error": "/var/log/xray/error.log"
    },
    "inbounds": [
        {
            "port": ${XRAY_PORT},
            "protocol": "vmess",
            "settings": {
                "clients": [
                    {
                        "id": "${UUID}",
                        "alterId": 0,
                        "email": "user@vmess.local",
                        "level": 1
                    }
                ],
                "disableInsecureEncryption": false
            },
            "streamSettings": {
                "network": "ws",
                "wsSettings": {
                    "path": "/${WS_PATH}"
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls"]
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "settings": {}
        },
        {
            "protocol": "blackhole",
            "settings": {},
            "tag": "blocked"
        }
    ],
    "routing": {
        "rules": [
            {
                "type": "field",
                "ip": ["geoip:private"],
                "outboundTag": "blocked"
            }
        ]
    }
}
EOF
    log_success "Xray 配置文件创建完成"
}

create_cloudflared_config() {
    log_step "创建 cloudflared 配置文件..."
    mkdir -p /etc/cloudflared
    cat > /etc/cloudflared/config.yml << EOF
tunnel: ${TUNNEL_ID}
credentials-file: /etc/cloudflared/${TUNNEL_ID}.json

metrics: 0.0.0.0:2000
no-autoupdate: true
logfile: /var/log/cloudflared/tunnel.log
loglevel: info

originRequest:
  connectTimeout: 30s
  keepAliveConnections: 100

ingress:
  - hostname: ${CF_DOMAIN}
    service: http://localhost:${XRAY_PORT}
  - service: http_status:404
EOF
    log_success "cloudflared 配置文件创建完成"
}

create_systemd_services() {
    log_step "创建 systemd 服务..."
    
    cat > /etc/systemd/system/xray.service << EOF
[Unit]
Description=Xray Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/xray run -config /etc/xray/config.json
Restart=on-failure
RestartSec=5s
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
    
    cat > /etc/systemd/system/cloudflared.service << EOF
[Unit]
Description=Cloudflare Tunnel Service
After=network.target xray.service

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/cloudflared tunnel run
Restart=on-failure
RestartSec=5s
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable xray >/dev/null 2>&1 || true
    systemctl enable cloudflared >/dev/null 2>&1 || true
    log_success "systemd 服务创建完成"
}

cloudflare_auth() {
    log_step "Cloudflare 认证..."
    echo ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo "  请在浏览器打开以下链接认证："
    echo -e "  ${BLUE}https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/trycloudflare/${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -n "  完成后按回车继续..."
    read
    
    /usr/local/bin/cloudflared tunnel login
    
    if [ -f ~/.cloudflared/cert.pem ]; then
        cp ~/.cloudflared/cert.pem /etc/cloudflared/cert.pem
        log_success "Cloudflare 认证完成"
    else
        log_error "认证失败"
        return 1
    fi
}

create_tunnel() {
    log_step "创建 Cloudflare 隧道..."
    /usr/local/bin/cloudflared tunnel delete "$TUNNEL_NAME" 2>/dev/null || true
    
    TUNNEL_OUTPUT=$(/usr/local/bin/cloudflared tunnel create "$TUNNEL_NAME" 2>&1)
    TUNNEL_ID=$(echo "$TUNNEL_OUTPUT" | grep -oP 'Created tunnel \K[a-f0-9-]+' || echo "")
    
    if [ -z "$TUNNEL_ID" ]; then
        log_error "创建隧道失败"
        return 1
    fi
    
    echo "$TUNNEL_ID" > /etc/cloudflared/tunnel-id
    CRED_FILE=$(echo "$TUNNEL_OUTPUT" | grep -oP '/[^ ]+\.json' | head -1 || echo "")
    if [ -n "$CRED_FILE" ] && [ -f "$CRED_FILE" ]; then
        cp "$CRED_FILE" /etc/cloudflared/${TUNNEL_ID}.json
    fi
    
    log_success "隧道创建完成：$TUNNEL_ID"
}

configure_dns() {
    log_step "配置 DNS 记录..."
    /usr/local/bin/cloudflared tunnel route dns "$TUNNEL_ID" "$CF_DOMAIN" 2>/dev/null || {
        log_warn "DNS 记录创建失败，请在 Cloudflare 后台手动添加"
    }
    log_success "DNS 记录配置完成"
}

start_services() {
    log_step "启动服务..."
    systemctl start xray
    sleep 2
    systemctl start cloudflared
    sleep 2
    
    if systemctl is-active --quiet xray && systemctl is-active --quiet cloudflared; then
        log_success "所有服务启动成功"
    else
        log_warn "部分服务启动失败，请检查日志"
    fi
}

stop_services() {
    log_step "停止服务..."
    systemctl stop cloudflared 2>/dev/null || true
    systemctl stop xray 2>/dev/null || true
    log_success "服务已停止"
}

restart_services() {
    log_step "重启服务..."
    systemctl restart xray
    systemctl restart cloudflared
    log_success "服务已重启"
}

show_config() {
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${WHITE}节点配置信息${NC}"
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${CYAN}【Xray 配置】${NC}"
    echo "  UUID:     ${UUID}"
    echo "  端口：     ${XRAY_PORT}"
    echo "  路径：     /${WS_PATH}"
    echo ""
    echo -e "${CYAN}【Cloudflare 配置】${NC}"
    echo "  域名：     ${CF_DOMAIN}"
    echo "  隧道 ID:   ${TUNNEL_ID}"
    echo ""
    echo -e "${CYAN}【客户端配置】${NC}"
    echo "  地址：     ${CF_DOMAIN}"
    echo "  端口：     443"
    echo "  协议：     vmess"
    echo "  传输：     ws+tls"
    echo "  路径：     /${WS_PATH}"
    echo "  UUID:      ${UUID}"
    echo ""
    
    local VMESS_JSON="{\"v\":\"2\",\"ps\":\"CF-Argo\",\"add\":\"${CF_DOMAIN}\",\"port\":\"443\",\"id\":\"${UUID}\",\"aid\":\"0\",\"net\":\"ws\",\"type\":\"none\",\"host\":\"${CF_DOMAIN}\",\"path\":\"/${WS_PATH}\",\"tls\":\"tls\"}"
    local VMESS_LINK="vmess://$(echo -n "$VMESS_JSON" | base64 -w 0)"
    
    echo -e "${CYAN}【vmess 链接】${NC}"
    echo "  $VMESS_LINK"
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

show_status() {
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${WHITE}服务状态${NC}"
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    
    if [ "$XRAY_INSTALLED" = true ]; then
        echo -e "  ${GREEN}✓${NC} Xray-core:     已安装 (${XRAY_VERSION})"
    else
        echo -e "  ${RED}✗${NC} Xray-core:     未安装"
    fi
    
    if [ "$XRAY_RUNNING" = true ]; then
        echo -e "  ${GREEN}✓${NC} Xray 服务：    运行中"
    else
        echo -e "  ${YELLOW}⚠${NC} Xray 服务：    未运行"
    fi
    
    if [ "$CF_INSTALLED" = true ]; then
        echo -e "  ${GREEN}✓${NC} cloudflared:   已安装 (${CF_VERSION})"
    else
        echo -e "  ${RED}✗${NC} cloudflared:   未安装"
    fi
    
    if [ "$CF_RUNNING" = true ]; then
        echo -e "  ${GREEN}✓${NC} Tunnel 服务：  运行中"
    else
        echo -e "  ${YELLOW}⚠${NC} Tunnel 服务：  未运行"
    fi
    
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

view_logs() {
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${WHITE}日志查看${NC}"
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "  1) Xray 日志  2) cloudflared 日志  3) Xray 错误日志  4) 返回"
    echo ""
    echo -n "  请选择 (1-4): "
    read LOG_OPTION
    
    case $LOG_OPTION in
        1) tail -20 /var/log/xray/access.log 2>/dev/null || echo "日志不存在" ;;
        2) journalctl -u cloudflared -n 20 --no-pager 2>/dev/null || echo "日志不可用" ;;
        3) tail -20 /var/log/xray/error.log 2>/dev/null || echo "日志不存在" ;;
        4) return ;;
        *) log_warn "无效选项" ;;
    esac
    echo ""
    echo -n "  按回车键返回..."
    read
}

update_components() {
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${WHITE}组件更新${NC}"
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "  1) 更新 Xray-core  2) 更新 cloudflared  3) 更新全部  4) 返回"
    echo ""
    echo -n "  请选择 (1-4): "
    read UPDATE_OPTION
    
    case $UPDATE_OPTION in
        1) stop_services; install_xray; start_services; log_success "Xray 更新完成" ;;
        2) systemctl stop cloudflared; install_cloudflared; systemctl start cloudflared; log_success "cloudflared 更新完成" ;;
        3) stop_services; install_xray; install_cloudflared; start_services; log_success "全部更新完成" ;;
        4) return ;;
        *) log_warn "无效选项" ;;
    esac
    echo ""
    echo -n "  按回车键返回..."
    read
}

uninstall_all() {
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${WHITE}⚠  警告：此操作将卸载所有组件并删除配置${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -n "  确定要卸载吗？(输入 yes 确认): "
    read CONFIRM
    
    if [ "$CONFIRM" != "yes" ]; then
        log_info "取消卸载"
        return
    fi
    
    log_step "开始卸载..."
    systemctl stop cloudflared xray 2>/dev/null || true
    systemctl disable cloudflared xray 2>/dev/null || true
    rm -f /etc/systemd/system/{xray,cloudflared}.service
    rm -f /usr/local/bin/{xray,xray-core,cloudflared}
    rm -rf /etc/{xray,cloudflared} /var/log/{xray,cloudflared} ~/.cloudflared
    systemctl daemon-reload
    log_success "卸载完成！"
    echo -e "${YELLOW}请手动清理 Cloudflare 后台的 Tunnel 和 DNS 记录${NC}"
    echo -n "  按回车键返回..."
    read
}

full_deploy() {
    echo ""
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${WHITE}全新部署${NC}"
    echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    
    if [ "$XRAY_INSTALLED" = true ] || [ "$CF_INSTALLED" = true ]; then
        log_warn "检测到已有组件安装"
        echo -n "  是否继续？(y/n): "
        read CONTINUE
        if [ "$CONTINUE" != "y" ] && [ "$CONTINUE" != "Y" ]; then
            return
        fi
    fi
    
    echo ""
    echo -e "${CYAN}请输入配置信息:${NC}"
    echo ""
    echo -n "  Cloudflare 域名 (例如：app.example.com): "
    read CF_DOMAIN
    echo -n "  Xray 监听端口 (默认：10000): "
    read XRAY_PORT_INPUT
    XRAY_PORT=${XRAY_PORT_INPUT:-10000}
    echo -n "  WS 路径 (默认：ray): "
    read WS_PATH_INPUT
    WS_PATH=$(echo "$WS_PATH_INPUT" | tr -d '/' | sed 's/^$/ray/')
    echo -n "  隧道名称 (默认：my-tunnel): "
    read TUNNEL_NAME_INPUT
    TUNNEL_NAME=${TUNNEL_NAME_INPUT:-my-tunnel}
    echo -n "  UUID (留空自动生成): "
    read UUID_INPUT
    if [ -z "$UUID_INPUT" ]; then
        UUID=$(generate_uuid)
        log_info "自动生成 UUID"
    else
        UUID=$UUID_INPUT
    fi
    
    log_step "开始部署..."
    
    detect_system
    detect_package_manager
    install_dependencies
    install_xray
    install_cloudflared
    create_xray_config
    cloudflare_auth
    create_tunnel
    create_cloudflared_config
    configure_dns
    create_systemd_services
    start_services
    
    show_config
    log_success "部署完成！"
    echo -n "  按回车键返回..."
    read
}

main_menu() {
    while true; do
        show_banner
        check_installation_status
        
        echo -e "  ${CYAN}系统信息:${NC}  $OS_PRETTY | $ARCH_NAME"
        echo ""
        echo -e "  ${CYAN}安装状态:${NC}"
        if [ "$XRAY_INSTALLED" = true ]; then
            echo -e "    ${GREEN}✓${NC} Xray-core: ${XRAY_VERSION}"
        else
            echo -e "    ${RED}✗${NC} Xray-core: 未安装"
        fi
        if [ "$CF_INSTALLED" = true ]; then
            echo -e "    ${GREEN}✓${NC} cloudflared: ${CF_VERSION}"
        else
            echo -e "    ${RED}✗${NC} cloudflared: 未安装"
        fi
        echo ""
        echo -e "  ${CYAN}运行状态:${NC}"
        if [ "$XRAY_RUNNING" = true ]; then
            echo -e "    ${GREEN}✓${NC} Xray: 运行中"
        else
            echo -e "    ${YELLOW}⚠${NC} Xray: 未运行"
        fi
        if [ "$CF_RUNNING" = true ]; then
            echo -e "    ${GREEN}✓${NC} Tunnel: 运行中"
        else
            echo -e "    ${YELLOW}⚠${NC} Tunnel: 未运行"
        fi
        
        echo ""
        echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo "    1) 全新部署   2) 查看配置   3) 查看状态   4) 启动服务"
        echo "    5) 停止服务   6) 重启服务   7) 查看日志   8) 更新组件"
        echo "    9) 一键卸载   0) 退出脚本"
        echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
        echo -n "  请选择 (0-9): "
        read OPTION
        
        case $OPTION in
            1) full_deploy ;;
            2)
                if [ -n "$UUID" ]; then
                    show_config
                else
                    log_warn "未找到配置"
                fi
                echo -n "  按回车返回..."; read
                ;;
            3) show_status; echo -n "  按回车返回..."; read ;;
            4) start_services; echo -n "  按回车返回..."; read ;;
            5) stop_services; echo -n "  按回车返回..."; read ;;
            6) restart_services; echo -n "  按回车返回..."; read ;;
            7) view_logs ;;
            8) update_components ;;
            9) uninstall_all ;;
            0) log_info "感谢使用，再见！"; exit 0 ;;
            *) log_warn "无效选项"; sleep 1 ;;
        esac
    done
}

# 主程序
main() {
    check_root
    detect_system
    detect_package_manager
    check_installation_status
    main_menu
}

main "$@"
